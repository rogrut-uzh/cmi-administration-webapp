{% extends 'base.html' %}

{% block title %}Cockpit{% endblock %}

{% block content %}
<div class="row align-items-start p-2">
    <div class="col p-2">
	
		<div class="row mb-2 align-items-start">
		  <div class="col-sm-6">
			<div class="card">
			  <div class="card-body">
				<h2 class="card-title">Monitoring</h2>
				<p class="card-text">Links to the Nagios page. Login with UZH shortname and password.</p>
				App:&nbsp;<a href="https://idnagiosmaster1.uzh.ch/thruk/cgi-bin/status.cgi?style=detail&s0_op=~&s0_type=search&add_default_service_filter=1&s0_value=ho%3Aziaxiomapap03" target="_blank" class="badge badge-primary">ziaxiomapap03</a>&nbsp;<a href="https://idnagiosmaster1.uzh.ch/thruk/cgi-bin/status.cgi?style=detail&s0_op=~&s0_type=search&add_default_service_filter=1&s0_value=ho%3Aziaxiomapap04" target="_blank" class="badge badge-primary">ziaxiomapap04</a>&nbsp;<a href="https://idnagiosmaster1.uzh.ch/thruk/cgi-bin/status.cgi?style=detail&s0_op=~&s0_type=search&add_default_service_filter=1&s0_value=ho%3Aziaxiomatap02" target="_blank" class="badge badge-primary">ziaxiomatap02</a><br/>Database:&nbsp;<a href="https://idnagiosmaster1.uzh.ch/thruk/cgi-bin/status.cgi?style=detail&s0_op=~&s0_type=search&add_default_service_filter=1&s0_value=ho%3Aziaxiomapsql02" target="_blank" class="badge badge-primary">ziaxiomapsql02</a>&nbsp;<a href="https://idnagiosmaster1.uzh.ch/thruk/cgi-bin/status.cgi?style=detail&s0_op=~&s0_type=search&add_default_service_filter=1&s0_value=ho%3Aziaxiomatsql02" target="_blank" class="badge badge-primary">ziaxiomatsql02</a>
			  </div>
			</div>
		  </div>
		  <div class="col-sm-6">
			<div class="card">
                <div class="card-body">
                    <h2 class="card-title">Logs</h2>
                    <p class="card-text">Download the log files of each CMI mandant to <strong>D:\cmi-log-files\</strong>.</p>
					<p>
						<label for="input-log-date">Enter the date in the format <code>yyyymmdd</code>:</label> 
						<input type="text" 
							id="input-log-date" 
							name="input-log-date" 
							class="form-control-inline" 
							style="width: 100px;" />
					</p>
                    <p>
					<fieldset id="log-env">
						Environment: 
                        <input type="radio" id="env-test" name="log-env" value="test" checked>
                        <label for="env-test">Test</label>
                        <input type="radio" id="env-prod" name="log-env" value="prod">
                        <label for="env-prod">Prod</label>
                    </fieldset>
					</p>
                    <button class="btn btn-primary btn-sm" id="get-log-files-btn">Download</button>
                    <span style="padding-left:10px;" class="get-date-result"></span>
                </div>
			</div>
		  </div>
		</div>
	
        <div class="row mb-2 align-items-start">
		  <div class="col">
		
			<div id="tableRaw"></div>
			
			<div class="card">
				<div class="card-body">
					<h2 class="card-title">CMI (Prod)</h2>
					<table id="dataTableCmiProd" class="table table-striped table-bordered"></table>
				</div>
			</div>
		  </div>
		</div>
        <div class="row mb-2 align-items-start">
		  <div class="col">
			<div class="card">
				<div class="card-body">
					<h2 class="card-title">AIS (Prod)</h2>
					<table id="dataTableAisProd" class="table table-striped table-bordered"></table>
				</div>
			</div>
			</div>
		</div>
        <div class="row mb-2 align-items-start">
		  <div class="col">
			<div class="card">
				<div class="card-body">
					<h2 class="card-title">CMI (Test)</h2>
					<table id="dataTableCmiTest" class="table table-striped table-bordered"></table>
				</div>
			</div>
		  </div>
		</div>
        <div class="row mb-2 align-items-start">
		  <div class="col">
			<div class="card">
				<div class="card-body">
					<h2 class="card-title">AIS (Test)</h2>
					<table id="dataTableAisTest" class="table table-striped table-bordered"></table>
				</div>
			</div>
		  </div>
        </div>
    </div>
</div>


<script>
	document.addEventListener("DOMContentLoaded", function(event) {
		runScriptCockpitOverview('cmi', 'prod');
		runScriptCockpitOverview('ais', 'prod');
		runScriptCockpitOverview('cmi', 'test');
		runScriptCockpitOverview('ais', 'test');
	});
	
	function getSubLevels(u) {
		var r = "";
		if (u) { // only if u is not undefined (= there are urls)
			for (var i = 0; i < u.length; i++) {
				r += "<br/>";
				r += u[i];
			}
		}
		return r;
	}

	function populateTable(data, app, env) {
		const tdclass = "py-1";
		
		var table;
		
		if (app == "cmi") {
			if (env == "prod") {
				table = document.querySelector("#dataTableCmiProd");
			} else {
				table = document.querySelector("#dataTableCmiTest");
			}
		} else {
			if (env == "prod") {
				table = document.querySelector("#dataTableAisProd");
			} else {
				table = document.querySelector("#dataTableAisTest");
			}
		}
		
		const tableHead = document.createElement("thead");
		table.appendChild(tableHead);
		
		const tableBody = document.createElement("tbody");
		table.appendChild(tableBody);
		
		
		const tableHeadTr = document.createElement("tr");
		tableHead.appendChild(tableHeadTr);
		
		const nameCellHeader = document.createElement("th");
		nameCellHeader.classList.add(tdclass);
		nameCellHeader.textContent = "Name";
		tableHeadTr.appendChild(nameCellHeader);
		
		const versionCellHeader = document.createElement("th");
		versionCellHeader.classList.add(tdclass);
		versionCellHeader.textContent = "Release";
		tableHeadTr.appendChild(versionCellHeader);
		
		const hostCellHeader = document.createElement("th");
		hostCellHeader.classList.add(tdclass);
		hostCellHeader.textContent = "Host";
		tableHeadTr.appendChild(hostCellHeader);
		
		const licenseCellHeader = document.createElement("th");
		licenseCellHeader.classList.add(tdclass);
		licenseCellHeader.textContent = "License Server";
		tableHeadTr.appendChild(licenseCellHeader);
		
		const mobileCellHeader = document.createElement("th");
		mobileCellHeader.classList.add(tdclass);
		mobileCellHeader.textContent = "Mobile Client";
		tableHeadTr.appendChild(mobileCellHeader);
		
		if (app == "cmi") {
			const ueberweisungCellHeader = document.createElement("th");
			ueberweisungCellHeader.classList.add(tdclass);
			ueberweisungCellHeader.textContent = "Ueberweisungen";
			tableHeadTr.appendChild(ueberweisungCellHeader);
		}
		
		const jobsCellHeader = document.createElement("th");
		jobsCellHeader.classList.add(tdclass);
		jobsCellHeader.textContent = "Jobs";
		tableHeadTr.appendChild(jobsCellHeader);
		

		// Loop through JSON data and create rows
		data.forEach(item => {
			const row = document.createElement("tr");

			// Create cells for each column
			//const environmentCell = document.createElement("td");
			//environmentCell.classList.add(tdclass);
			//environmentCell.textContent = env || "";
			//row.appendChild(environmentCell);
			//
			//const appTypeCell = document.createElement("td");
			//appTypeCell.classList.add(tdclass);
			//appTypeCell.textContent = app || "";
			//row.appendChild(appTypeCell);

			const nameCell = document.createElement("th");
			nameCell.classList.add(tdclass);
			nameCell.textContent = item.namefull || "";
			nameCell.setAttribute('scope', 'row');
			row.appendChild(nameCell);

			const versionCell = document.createElement("td");
			versionCell.classList.add(tdclass);
			versionCell.textContent = item.app.releaseversion || "";
			row.appendChild(versionCell);

			const hostCell = document.createElement("td");
			hostCell.classList.add(tdclass);
			hostCell.textContent = item.app.host || "";
			row.appendChild(hostCell);

			const licenseCell = document.createElement("td");
			licenseCell.classList.add(tdclass);
			licenseCell.textContent = item.licenseserver ? "Yes" : "No";
			row.appendChild(licenseCell);

			const mobileCell = document.createElement("td");
			mobileCell.classList.add(tdclass);
			const link = document.createElement("a");
			link.href = item.mobilefirst;
			link.textContent = item.mobilefirst;
			link.target = "_blank";
			mobileCell.appendChild(link);
			row.appendChild(mobileCell);

			if (app == "cmi") {
				const ueberweisungCell = document.createElement("td");
				ueberweisungCell.classList.add(tdclass);
				ueberweisungCell.innerHTML = "Port: "+item.ueberweisung.port || "";
				ueberweisungCell.innerHTML += getSubLevels(item.ueberweisung.url) || "";
				row.appendChild(ueberweisungCell);
			}
			
			const jobsCell = document.createElement("td");
			jobsCell.classList.add(tdclass);
			if (item.jobs) {
				if (item.jobs.adrsync) {
					jobsCell.innerHTML += "<b>Adr. Sync: </b>"+item.jobs.adrsync+"<br/>" || "";
				}
				if (item.jobs.fulltextoptimize) {
					jobsCell.innerHTML += "<b>Fulltext Index Optimize: </b>"+item.jobs.fulltextoptimize+"<br/>" || "";
				}
				if (item.jobs.fulltextrebuild) {
					jobsCell.innerHTML += "<b>Fulltext Index Rebuild: </b>"+item.jobs.fulltextrebuild || "";
				}
			}
			row.appendChild(jobsCell);

			// Append row to the table body
			tableBody.appendChild(row);
		});
	}
	
    // Function to run a script with specified arguments
    async function runScriptCockpitOverview(app, env) {
        // Prepare the output element
        const tableRaw = document.getElementById("tableRaw");
        tableRaw.textContent = `Running script with: App=${app}, Env=${env}...\n`;

		try {
			const response = await fetch('/run-script-cockpit-overview', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({ app, env })
			});

			if (response.ok) {
				const result = await response.json();

				// ----- Access the response data for debugging -----
				//const status = result.Status || "Unknown";
				//const data = result.Data || [];
				//tableRaw.textContent += `Status: ${status}\nData:\n${JSON.stringify(data, null, 2)}`;
				
				tableRaw.textContent = "";
                populateTable(result.Data || [], app, env);
			} else {
				const error = await response.json();
				tableRaw.textContent += `Error: ${error.error}`;
			}
		} catch (error) {
			tableRaw.textContent += `Error: ${error.message}`;
		}
	}
	
</script>

<script>
document.getElementById("get-log-files-btn").addEventListener("click", async function() {
    // Reset the result span
    const resultSpan = document.querySelector(".get-date-result");
    resultSpan.textContent = "";
    
    // Get the entered date and selected environment
    const logDate = document.getElementById("input-log-date").value.trim();
    const env = document.querySelector('input[name="log-env"]:checked').value;

    // Validate date input field
    const dateRegex = /^\d{4}(0[1-9]|1[0-2])(0[1-9]|[12][0-9]|3[01])$/; // yyyymmdd format

    if (!dateRegex.test(logDate)) {
        resultSpan.textContent = "Invalid date format. Please use yyyymmdd.";
        resultSpan.style.color = "red";
        return;
    }
    
    // Show "Downloading..." in the span
    resultSpan.style.color = ""; // Reset the color
    resultSpan.textContent = "Downloading...";
    
    // Call the Flask endpoint
    try {
        const response = await fetch(`/get-log-files?log_date=${logDate}&env=${env}`, {
            method: "GET",
        });

        if (response.ok) {
            const blob = await response.blob();
            const downloadUrl = URL.createObjectURL(blob);
            
            // Create a temporary link to download the file
            const link = document.createElement("a");
            link.href = downloadUrl;

            // Extract filename from response headers or use a default name
            const contentDisposition = response.headers.get("Content-Disposition");
            let filename = "logs.zip"; // Default filename
            if (contentDisposition) {
                const match = contentDisposition.match(/filename="(.+)"/);
                if (match) {
                    filename = match[1];
                }
            }

            link.download = filename;
            link.click();

            URL.revokeObjectURL(downloadUrl); // Clean up the URL
            resultSpan.textContent = "Download complete.";
        } else {
            const error = await response.json();
            resultSpan.textContent = `Error: ${error.error}`;
        }
    } catch (error) {
        resultSpan.textContent = `Error: ${error.message}`;
    }
});
//    document.getElementById("get-log-files-btn").addEventListener("click", async function() {
//        // Reset the result span
//        const resultSpan = document.querySelector(".get-date-result");
//        resultSpan.textContent = "";
//		
//        // Get the entered date and selected environment
//        const logDate = document.getElementById("input-log-date").value.trim();
//        const env = document.querySelector('input[name="log-env"]:checked').value;
//
//		// validate date input field
//        const dateRegex = /^\d{4}(0[1-9]|1[0-2])(0[1-9]|[12][0-9]|3[01])$/; // yyyymmdd format
//
//        if (!dateRegex.test(logDate)) {
//            resultSpan.textContent = "Invalid date format. Please use yyyymmdd.";
//            resultSpan.style.color = "red";
//            return;
//        }
//		
//        // Show "Downloading..." in the span
//        resultSpan.style.color = ""; // Reset the color
//        resultSpan.textContent = "Downloading...";
//		
//        // Call the Flask endpoint
//        try {
//            const response = await fetch("/get-log-files", {
//                method: "POST",
//                headers: { "Content-Type": "application/json" },
//                body: JSON.stringify({ log_date: logDate, env: env }),
//            });
//
//            if (response.ok) {
//                const result = await response.json();
//                resultSpan.textContent = result.message;
//            } else {
//                const error = await response.json();
//                resultSpan.textContent = `Error: ${error.error}`;
//            }
//        } catch (error) {
//            resultSpan.textContent = `Error: ${error.message}`;
//        }
//    });
//
</script>
{% endblock %}