{% extends 'base.html' %}

{% block title %}CMI Services{% endblock %}

{% block content %}
<div class="row align-items-start p-2">
    <!-- Left Column: Buttons and Actions -->
    <div class="col-4 p-2">
        <div class="row mb-2 align-items-start">
            <div class="col">
                <h2 class="mb-0">Start/Stop CMI Services</h2>
            </div>
        </div>

        <!-- Stop Buttons -->
        <div class="row mb-2 align-items-start">
            <div class="col d-flex flex-nowrap">
                <button class="btn mr-2 btn-sm btn-warning" onclick="runScriptServices('stop', 'cmi', 'test', 'group-cmi-services')">Stop CMI Test</button>
                <button class="btn mr-2 btn-sm btn-danger" onclick="runScriptServices('stop', 'cmi', 'prod', 'group-cmi-services')">Stop CMI Prod</button>
                <button class="btn mr-2 btn-sm btn-warning" onclick="runScriptServices('stop', 'ais', 'test', 'group-cmi-services')">Stop AIS Test</button>
                <button class="btn mr-2 btn-sm btn-danger" onclick="runScriptServices('stop', 'ais', 'prod', 'group-cmi-services')">Stop AIS Prod</button>
            </div>
        </div>

        <!-- Start Buttons -->
        <div class="row mb-2 align-items-start">
            <div class="col d-flex flex-nowrap">
                <button class="btn mr-2 btn-sm btn-primary" onclick="runScriptServices('start', 'cmi', 'test', 'group-cmi-services')">Start CMI Test</button>
                <button class="btn mr-2 btn-sm btn-primary" onclick="runScriptServices('start', 'cmi', 'prod', 'group-cmi-services')">Start CMI Prod</button>
                <button class="btn mr-2 btn-sm btn-primary" onclick="runScriptServices('start', 'ais', 'test', 'group-cmi-services')">Start AIS Test</button>
                <button class="btn mr-2 btn-sm btn-primary" onclick="runScriptServices('start', 'ais', 'prod', 'group-cmi-services')">Start AIS Prod</button>
            </div>
        </div>

        <!-- Checkbox -->
        <div class="row mb-2 align-items-start">
            <div class="col d-flex flex-nowrap">
                <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" id="includeRelay" checked>
                    <label for="includeRelay" class="form-check-label">inklusive Relay-Server</label>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Output -->
    <div class="col-8 p-2 output">
        <h5>Output</h5>
        <pre id="output">Click a button to see the output here.</pre>
    </div>
</div>

<!-- JavaScript -->
<script>
    // Function to run a script with specified arguments
    function runScriptServices(action, app, env, groupId) {
        // Disable only the buttons in this group
        disableButtonGroup(groupId);

        // Get the state of the checkbox
        const includeRelay = document.getElementById("includeRelay").checked;

        // Prepare the output element
        const outputElement = document.getElementById("output");
        outputElement.textContent = `Running script with: Action=${action}, App=${app}, Env=${env}, IncludeRelay=${includeRelay}...\n`;

        // Create an EventSource for real-time updates
        const eventSource = new EventSource(`/run-script-services-stream?action=${action}&app=${app}&env=${env}&includeRelay=${includeRelay}`);

        // Handle incoming data from the server
        eventSource.onmessage = (event) => {
            outputElement.textContent += `${event.data}\n`;
        };

        // Handle errors
        eventSource.onerror = () => {
            outputElement.textContent += "\nConnection closed.";
            eventSource.close();
            enableButtonGroup(groupId); // Re-enable the buttons in this group
        };
    }
	
    // Disable only buttons within a specific group
    function disableButtonGroup(groupId) {
        const buttons = document.querySelectorAll(`#${groupId} button`);
        buttons.forEach(button => button.disabled = true);
    }

    // Enable only buttons within a specific group
    function enableButtonGroup(groupId) {
        const buttons = document.querySelectorAll(`#${groupId} button`);
        buttons.forEach(button => button.disabled = false);
    }
</script>
{% endblock %}
